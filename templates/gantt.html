{% extends 'base.html' %}
{% block sub_content %}

<script src="/static/highcharts/code/highcharts.js"></script>
<script src="/static/highcharts/code/highcharts-more.js"></script>
<script src="/static/highcharts/code/modules/gantt.js"></script>
<script src="/static/highcharts/code/modules/accessibility.js"></script>

<div style="margin-bottom: 1em;">
  <button onclick="setZoom(1)">1 день</button>
  <button onclick="setZoom(7)">1 неделя</button>
  <button onclick="setZoom(30)">1 месяц</button>
  <button onclick="setZoom(90)">3 месяца</button>
  <button onclick="setZoom(365)">1 год</button>
  <button onclick="setZoom('all')">все</button>
</div>


<div id="ganttContainer"></div>

<style>
  #ganttContainer {
    width: 100%;
    height: 100vh;
  }
</style>

<script>
  const ganttData = {{ gantt_data | tojson }};
  const specName = "{{ spec_name }}";

  function prepareTasks(data) {
    return data.map(task => ({
      id: task.id,
      name: task.name,
      parent: task.parent || undefined,
      start: task.d_start ? Date.parse(task.d_start) : undefined,
      end: task.d_end ? Date.parse(task.d_end) : undefined,
      color: task.color,
      dependency: task.dependency || undefined,
      completed: task.completed || { amount: 0 }
    }));
  }

  const tasks = prepareTasks(ganttData);
  const chart = Highcharts.ganttChart('ganttContainer', {
    title: {
      text: specName
    },
    chart: {
      zoomType: 'x'
    },
    xAxis: {
      type: 'datetime',
      labels: {
        formatter: function () {
          const range = this.axis.max - this.axis.min;
          if (range <= 36 * 60 * 60 * 1000) {
            return Highcharts.dateFormat('%H:%M', this.value);
          } else if (range <= 10 * 24 * 60 * 60 * 1000) {
            return Highcharts.dateFormat('%e %b', this.value);
          } else {
            return Highcharts.dateFormat('%b %Y', this.value);
          }
        }
      }
    },
    navigator: {
      enabled: true
    },
    scrollbar: {
      enabled: true
    },
    series: [{
      name: 'Составляющие',
      data: tasks
    }]
  });

  function setZoom(days) {
  if (!tasks.length) return;

  const minDate = Math.min(...tasks.map(t => t.start || Infinity));
  const maxDate = Math.max(...tasks.map(t => t.end || -Infinity));

  if (days === 'all') {
    chart.xAxis[0].setExtremes(minDate, maxDate);
    return;
  }

  const center = (minDate + maxDate) / 2;
  const halfSpan = (days * 24 * 60 * 60 * 1000) / 2;
  chart.xAxis[0].setExtremes(center - halfSpan, center + halfSpan);
}

</script>



{% endblock %}
